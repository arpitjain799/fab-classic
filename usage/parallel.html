
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Parallel execution &#8212; fab-classic  documentation</title>
    <link rel="stylesheet" href="../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="SSH behavior" href="ssh.html" />
    <link rel="prev" title="Managing output" href="output_controls.html" />
   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <div class="section" id="parallel-execution">
<h1>Parallel execution<a class="headerlink" href="#parallel-execution" title="Permalink to this headline">¶</a></h1>
<div class="versionadded" id="id1">
<p><span class="versionmodified">New in version 1.3.</span></p>
</div>
<p>By default, Fabric executes all specified tasks <strong>serially</strong> (see
<a class="reference internal" href="execution.html#execution-strategy"><span class="std std-ref">Execution strategy</span></a> for details.) This document describes Fabric’s
options for running tasks on multiple hosts in <strong>parallel</strong>, via per-task
decorators and/or global command-line switches.</p>
<div class="section" id="what-it-does">
<h2>What it does<a class="headerlink" href="#what-it-does" title="Permalink to this headline">¶</a></h2>
<p>Because Fabric 1.x is not fully threadsafe (and because in general use, task
functions do not typically interact with one another) this functionality is
implemented via the Python <a class="reference external" href="http://docs.python.org/library/multiprocessing.html">multiprocessing</a> module. It creates one
new process for each host and task combination, optionally using a
(configurable) sliding window to prevent too many processes from running at the
same time.</p>
<p>For example, imagine a scenario where you want to update Web application code
on a number of Web servers, and then reload the servers once the code has been
distributed everywhere (to allow for easier rollback if code updates fail.) One
could implement this with the following fabfile:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">fabric.api</span> <span class="k">import</span> <span class="o">*</span>

<span class="k">def</span> <span class="nf">update</span><span class="p">():</span>
    <span class="k">with</span> <span class="n">cd</span><span class="p">(</span><span class="s2">&quot;/srv/django/myapp&quot;</span><span class="p">):</span>
        <span class="n">run</span><span class="p">(</span><span class="s2">&quot;git pull&quot;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">reload</span><span class="p">():</span>
    <span class="n">sudo</span><span class="p">(</span><span class="s2">&quot;service apache2 reload&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>and execute it on a set of 3 servers, in serial, like so:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ fab -H web1,web2,web3 update reload
</pre></div>
</div>
<p>Normally, without any parallel execution options activated, Fabric would run
in order:</p>
<ol class="arabic simple">
<li><code class="docutils literal notranslate"><span class="pre">update</span></code> on <code class="docutils literal notranslate"><span class="pre">web1</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">update</span></code> on <code class="docutils literal notranslate"><span class="pre">web2</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">update</span></code> on <code class="docutils literal notranslate"><span class="pre">web3</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">reload</span></code> on <code class="docutils literal notranslate"><span class="pre">web1</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">reload</span></code> on <code class="docutils literal notranslate"><span class="pre">web2</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">reload</span></code> on <code class="docutils literal notranslate"><span class="pre">web3</span></code></li>
</ol>
<p>With parallel execution activated (via <a class="reference internal" href="fab.html#cmdoption-parallel"><code class="xref std std-option docutils literal notranslate"><span class="pre">-P</span></code></a> – see below for details),
this turns into:</p>
<ol class="arabic simple">
<li><code class="docutils literal notranslate"><span class="pre">update</span></code> on <code class="docutils literal notranslate"><span class="pre">web1</span></code>, <code class="docutils literal notranslate"><span class="pre">web2</span></code>, and <code class="docutils literal notranslate"><span class="pre">web3</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">reload</span></code> on <code class="docutils literal notranslate"><span class="pre">web1</span></code>, <code class="docutils literal notranslate"><span class="pre">web2</span></code>, and <code class="docutils literal notranslate"><span class="pre">web3</span></code></li>
</ol>
<p>Hopefully the benefits of this are obvious – if <code class="docutils literal notranslate"><span class="pre">update</span></code> took 5 seconds to
run and <code class="docutils literal notranslate"><span class="pre">reload</span></code> took 2 seconds, serial execution takes (5+2)*3 = 21 seconds
to run, while parallel execution takes only a third of the time, (5+2) = 7
seconds on average.</p>
</div>
<div class="section" id="how-to-use-it">
<h2>How to use it<a class="headerlink" href="#how-to-use-it" title="Permalink to this headline">¶</a></h2>
<div class="section" id="decorators">
<h3>Decorators<a class="headerlink" href="#decorators" title="Permalink to this headline">¶</a></h3>
<p>Since the minimum “unit” that parallel execution affects is a task, the
functionality may be enabled or disabled on a task-by-task basis using the
<a class="reference internal" href="../api/core/decorators.html#fabric.decorators.parallel" title="fabric.decorators.parallel"><code class="xref py py-obj docutils literal notranslate"><span class="pre">parallel</span></code></a> and <a class="reference internal" href="../api/core/decorators.html#fabric.decorators.serial" title="fabric.decorators.serial"><code class="xref py py-obj docutils literal notranslate"><span class="pre">serial</span></code></a> decorators. For
example, this fabfile:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">fabric.api</span> <span class="k">import</span> <span class="o">*</span>

<span class="nd">@parallel</span>
<span class="k">def</span> <span class="nf">runs_in_parallel</span><span class="p">():</span>
    <span class="k">pass</span>

<span class="k">def</span> <span class="nf">runs_serially</span><span class="p">():</span>
    <span class="k">pass</span>
</pre></div>
</div>
<p>when run in this manner:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ fab -H host1,host2,host3 runs_in_parallel runs_serially
</pre></div>
</div>
<p>will result in the following execution sequence:</p>
<ol class="arabic simple">
<li><code class="docutils literal notranslate"><span class="pre">runs_in_parallel</span></code> on <code class="docutils literal notranslate"><span class="pre">host1</span></code>, <code class="docutils literal notranslate"><span class="pre">host2</span></code>, and <code class="docutils literal notranslate"><span class="pre">host3</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">runs_serially</span></code> on <code class="docutils literal notranslate"><span class="pre">host1</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">runs_serially</span></code> on <code class="docutils literal notranslate"><span class="pre">host2</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">runs_serially</span></code> on <code class="docutils literal notranslate"><span class="pre">host3</span></code></li>
</ol>
</div>
<div class="section" id="command-line-flags">
<h3>Command-line flags<a class="headerlink" href="#command-line-flags" title="Permalink to this headline">¶</a></h3>
<p>One may also force all tasks to run in parallel by using the command-line flag
<a class="reference internal" href="fab.html#cmdoption-parallel"><code class="xref std std-option docutils literal notranslate"><span class="pre">-P</span></code></a> or the env variable <a class="reference internal" href="env.html#env-parallel"><span class="std std-ref">env.parallel</span></a>.  However,
any task specifically wrapped with <a class="reference internal" href="../api/core/decorators.html#fabric.decorators.serial" title="fabric.decorators.serial"><code class="xref py py-obj docutils literal notranslate"><span class="pre">serial</span></code></a> will ignore this
setting and continue to run serially.</p>
<p>For example, the following fabfile will result in the same execution sequence
as the one above:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">fabric.api</span> <span class="k">import</span> <span class="o">*</span>

<span class="k">def</span> <span class="nf">runs_in_parallel</span><span class="p">():</span>
    <span class="k">pass</span>

<span class="nd">@serial</span>
<span class="k">def</span> <span class="nf">runs_serially</span><span class="p">():</span>
    <span class="k">pass</span>
</pre></div>
</div>
<p>when invoked like so:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ fab -H host1,host2,host3 -P runs_in_parallel runs_serially
</pre></div>
</div>
<p>As before, <code class="docutils literal notranslate"><span class="pre">runs_in_parallel</span></code> will run in parallel, and <code class="docutils literal notranslate"><span class="pre">runs_serially</span></code> in
sequence.</p>
</div>
</div>
<div class="section" id="bubble-size">
<h2>Bubble size<a class="headerlink" href="#bubble-size" title="Permalink to this headline">¶</a></h2>
<p>With large host lists, a user’s local machine can get overwhelmed by running
too many concurrent Fabric processes. Because of this, you may opt to use a
moving bubble approach that limits Fabric to a specific number of concurrently
active processes.</p>
<p>By default, no bubble is used and all hosts are run in one concurrent pool. You
can override this on a per-task level by specifying the <code class="docutils literal notranslate"><span class="pre">pool_size</span></code> keyword
argument to <a class="reference internal" href="../api/core/decorators.html#fabric.decorators.parallel" title="fabric.decorators.parallel"><code class="xref py py-obj docutils literal notranslate"><span class="pre">parallel</span></code></a>, or globally via <a class="reference internal" href="fab.html#cmdoption-z"><code class="xref std std-option docutils literal notranslate"><span class="pre">-z</span></code></a>.</p>
<p>For example, to run on 5 hosts at a time:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">fabric.api</span> <span class="k">import</span> <span class="o">*</span>

<span class="nd">@parallel</span><span class="p">(</span><span class="n">pool_size</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">heavy_task</span><span class="p">():</span>
    <span class="c1"># lots of heavy local lifting or lots of IO here</span>
</pre></div>
</div>
<p>Or skip the <code class="docutils literal notranslate"><span class="pre">pool_size</span></code> kwarg and instead:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ fab -P -z 5 heavy_task
</pre></div>
</div>
</div>
<div class="section" id="linewise-vs-bytewise-output">
<span id="linewise-output"></span><h2>Linewise vs bytewise output<a class="headerlink" href="#linewise-vs-bytewise-output" title="Permalink to this headline">¶</a></h2>
<p>Fabric’s default mode of printing to the terminal is byte-by-byte, in order to
support <a class="reference internal" href="interactivity.html"><span class="doc">Interaction with remote programs</span></a>. This often gives poor results when running
in parallel mode, as the multiple processes may write to your terminal’s
standard out stream simultaneously.</p>
<p>To help offset this problem, Fabric’s option for linewise output is
automatically enabled whenever parallelism is active. This will cause you to
lose most of the benefits outlined in the above link Fabric’s remote
interactivity features, but as those do not map well to parallel invocations,
it’s typically a fair trade.</p>
<p>There’s no way to avoid the multiple processes mixing up on a line-by-line
basis, but you will at least be able to tell them apart by the host-string line
prefix.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Future versions will add improved logging support to make troubleshooting
parallel runs easier.</p>
</div>
</div>
</div>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<p class="logo">
  <a href="../index.html">
    <img class="logo" src="../_static/logo.png" alt="Logo"/>
    
    <h1 class="logo logo-name">fab-classic</h1>
    
  </a>
</p>



<p class="blurb">Pythonic remote execution</p>




<p>
<iframe src="https://ghbtns.com/github-btn.html?user=ploxiln&repo=fab-classic&type=watch&count=true&size=large&v=2"
  allowtransparency="true" frameborder="0" scrolling="0" width="200px" height="35px"></iframe>
</p>





    

<p>
<a class="badge" href="https://travis-ci.org/ploxiln/fab-classic">
    <img
        alt="https://secure.travis-ci.org/ploxiln/fab-classic.svg?branch=master"
        src="https://secure.travis-ci.org/ploxiln/fab-classic.svg?branch=master"
    />
</a>
</p>


<h3>Navigation</h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../installing.html">Installing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tutorial.html">Overview and Tutorial</a></li>
</ul>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="env.html">The environment dictionary, <code class="docutils literal notranslate"><span class="pre">env</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="execution.html">Execution model</a></li>
<li class="toctree-l1"><a class="reference internal" href="fab.html"><code class="docutils literal notranslate"><span class="pre">fab</span></code> options and arguments</a></li>
<li class="toctree-l1"><a class="reference internal" href="fabfiles.html">Fabfile construction and use</a></li>
<li class="toctree-l1"><a class="reference internal" href="interactivity.html">Interaction with remote programs</a></li>
<li class="toctree-l1"><a class="reference internal" href="library.html">Library Use</a></li>
<li class="toctree-l1"><a class="reference internal" href="output_controls.html">Managing output</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Parallel execution</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#what-it-does">What it does</a></li>
<li class="toctree-l2"><a class="reference internal" href="#how-to-use-it">How to use it</a></li>
<li class="toctree-l2"><a class="reference internal" href="#bubble-size">Bubble size</a></li>
<li class="toctree-l2"><a class="reference internal" href="#linewise-vs-bytewise-output">Linewise vs bytewise output</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="ssh.html">SSH behavior</a></li>
<li class="toctree-l1"><a class="reference internal" href="tasks.html">Defining tasks</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../troubleshooting.html">Troubleshooting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../faq.html">Frequently Asked Questions (FAQ)</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../api/core/colors.html">Color output functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api/core/context_managers.html">Context Managers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api/core/decorators.html">Decorators</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api/core/docs.html">Documentation helpers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api/core/network.html">Network</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api/core/operations.html">Operations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api/core/tasks.html">Tasks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api/core/utils.html">Utils</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../api/contrib/console.html">Console Output Utilities</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api/contrib/django.html">Django Integration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api/contrib/files.html">File and Directory Management</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api/contrib/project.html">Project Tools</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../running_tests.html">Running Fabric’s Tests</a></li>
<li class="toctree-l1"><a class="reference internal" href="../old_changelog.html">Old Changelog</a></li>
</ul>


<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;Fabric authors.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.7.9</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
      |
      <a href="../_sources/usage/parallel.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>